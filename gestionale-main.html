<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Edile Pro - Cloud</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .sync-status {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #212529;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .qr-container {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .backup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .setup-screen {
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .setup-screen h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .setup-screen p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .url-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            word-break: break-all;
            font-family: monospace;
            border: 2px dashed #667eea;
        }

        @media print {
            .nav-tabs, .btn, .modal { display: none !important; }
            .content { padding: 0; }
            body { background: white; }
            .container { box-shadow: none; }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
            }

            .sync-status {
                position: static;
                margin-top: 15px;
                display: inline-flex;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏗️ Gestionale Edile Pro</h1>
            <p>Sistema Cloud Multi-Utente in Tempo Reale</p>
            <div class="sync-status">
                <div class="sync-dot"></div>
                <span id="sync-text">Sincronizzato</span>
            </div>
        </div>

        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-screen" style="display: none;">
            <h2>🔧 Configurazione Database Condiviso</h2>
            <p>Per utilizzare il gestionale con più utenti contemporaneamente, inserisci un <strong>ID Database Unico</strong>.</p>
            <p><strong>🌐 IMPORTANTE:</strong> Questo gestionale è ospitato online! Tutti gli utenti che aprono questo link e usano lo stesso ID vedranno gli stessi dati in tempo reale!</p>
            
            <div class="alert alert-success" style="text-align: left;">
                <strong>✅ Come funziona:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>Tu</strong> inserisci un ID (es: "impresa-rossi-2025")</li>
                    <li><strong>Condividi</strong> questo link + l'ID con i colleghi</li>
                    <li><strong>Tutti</strong> che usano lo stesso ID vedono gli stessi dati</li>
                    <li><strong>Sincronizzazione</strong> automatica ogni 3 secondi!</li>
                </ul>
            </div>

            <div class="url-display">
                <strong>🔗 Link di questo gestionale:</strong><br>
                <span id="current-url" style="color: #667eea; font-weight: bold;"></span>
            </div>

            <div class="form-group">
                <label>ID Database Condiviso *</label>
                <input type="text" id="database-id" placeholder="es: mia-impresa-edile-2025" style="text-align: center; font-size: 18px;">
            </div>

            <button class="btn btn-primary" onclick="setupDatabase()" style="font-size: 18px; padding: 15px 40px;">
                ✓ Inizia
            </button>

            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                <p style="font-size: 14px; color: #999;">
                    <strong>📱 Accessibile da:</strong> Computer, Tablet, Smartphone<br>
                    <strong>☁️ Backup:</strong> Disponibile nella sezione dedicata
                </p>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dashboard')">📊 Dashboard</button>
                <button class="nav-tab" onclick="switchTab('cantieri')">🏗️ Cantieri</button>
                <button class="nav-tab" onclick="switchTab('attrezzature')">🚜 Attrezzature</button>
                <button class="nav-tab" onclick="switchTab('dipendenti')">👷 Dipendenti</button>
                <button class="nav-tab" onclick="switchTab('presenze')">⏰ Presenze</button>
                <button class="nav-tab" onclick="switchTab('manutenzioni')">🔧 Manutenzioni</button>
                <button class="nav-tab" onclick="switchTab('fornitori')">📦 Fornitori</button>
                <button class="nav-tab" onclick="switchTab('report')">📄 Report</button>
                <button class="nav-tab" onclick="switchTab('backup')">☁️ Backup</button>
            </div>

            <div class="content">
                <!-- DASHBOARD -->
                <div id="dashboard" class="tab-content active">
                    <h2>Dashboard Generale</h2>
                    <div class="alert alert-success">
                        <strong>✓ Connesso al Cloud!</strong> Database ID: <strong id="current-db-id"></strong><br>
                        <small>Tutti gli utenti con questo ID vedono gli stessi dati. Sincronizzazione automatica ogni 3 secondi.</small>
                    </div>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <h3>Cantieri Attivi</h3>
                            <div class="number" id="stat-cantieri">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Attrezzature</h3>
                            <div class="number" id="stat-attrezzature">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Dipendenti</h3>
                            <div class="number" id="stat-dipendenti">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Presenze Oggi</h3>
                            <div class="number" id="stat-presenze">0</div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>ℹ️ Sincronizzazione Multi-Dispositivo:</strong><br>
                        • Apri questo gestionale da PC, tablet o smartphone<br>
                        • Ogni modifica è visibile a tutti in tempo reale<br>
                        • Perfetto per coordinare più cantieri contemporaneamente!
                    </div>
                </div>

                <!-- CANTIERI -->
                <div id="cantieri" class="tab-content">
                    <h2>Gestione Cantieri</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addCantiereModal')">➕ Nuovo Cantiere</button>
                    </div>
                    <input type="text" class="search-box" id="searchCantieri" placeholder="🔍 Cerca cantiere..." onkeyup="searchTable('cantieriTable', 'searchCantieri')">
                    <table class="data-table" id="cantieriTable">
                        <thead>
                            <tr>
                                <th>Nome Cantiere</th>
                                <th>Indirizzo</th>
                                <th>Cliente</th>
                                <th>Data Inizio</th>
                                <th>Data Fine</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="cantieriTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                    Nessun cantiere inserito. Clicca "Nuovo Cantiere" per iniziare.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ATTREZZATURE -->
                <div id="attrezzature" class="tab-content">
                    <h2>Gestione Attrezzature e Mezzi</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addAttrezzaturaModal')">➕ Nuova Attrezzatura</button>
                    </div>
                    <input type="text" class="search-box" id="searchAttrezzature" placeholder="🔍 Cerca attrezzatura..." onkeyup="searchTable('attrezzatureTable', 'searchAttrezzature')">
                    <table class="data-table" id="attrezzatureTable">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Cantiere</th>
                                <th>Stato</th>
                                <th>QR Code</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="attrezzatureTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                    Nessuna attrezzatura inserita. Clicca "Nuova Attrezzatura" per iniziare.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- DIPENDENTI -->
                <div id="dipendenti" class="tab-content">
                    <h2>Gestione Dipendenti</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addDipendenteModal')">➕ Nuovo Dipendente</button>
                    </div>
                    <input type="text" class="search-box" id="searchDipendenti" placeholder="🔍 Cerca dipendente..." onkeyup="searchTable('dipendentiTable', 'searchDipendenti')">
                    <table class="data-table" id="dipendentiTable">
                        <thead>
                            <tr>
                                <th>Matricola</th>
                                <th>Nome Completo</th>
                                <th>Ruolo</th>
                                <th>Telefono</th>
                                <th>Email</th>
                                <th>QR Code</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="dipendentiTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                    Nessun dipendente inserito. Clicca "Nuovo Dipendente" per iniziare.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- PRESENZE -->
                <div id="presenze" class="tab-content">
                    <h2>Registro Presenze</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addPresenzaModal')">➕ Registra Presenza</button>
                        <button class="btn btn-success" onclick="openModal('scanQRModal')">📷 Scansiona QR</button>
                    </div>
                    <input type="text" class="search-box" id="searchPresenze" placeholder="🔍 Cerca presenza..." onkeyup="searchTable('presenzeTable', 'searchPresenze')">
                    <table class="data-table" id="presenzeTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Dipendente</th>
                                <th>Cantiere</th>
                                <th>Ora Ingresso</th>
                                <th>Ora Uscita</th>
                                <th>Ore Totali</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="presenzeTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                    Nessuna presenza registrata. Clicca "Registra Presenza" per iniziare.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- MANUTENZIONI -->
                <div id="manutenzioni" class="tab-content">
                    <h2>Calendario Manutenzioni</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addManutenzioneModal')">➕ Nuova Manutenzione</button>
                    </div>
                    <input type="text" class="search-box" id="searchManutenzioni" placeholder="🔍 Cerca manutenzione..." onkeyup="searchTable('manutenzioniTable', 'searchManutenzioni')">
                    <table class="data-table" id="manutenzioniTable">
                        <thead>
                            <tr>
                                <th>Data Prevista</th>
                                <th>Attrezzatura</th>
                                <th>Tipo Manutenzione</th>
                                <th>Descrizione</th>
                                <th>Stato</th>
                                <th>Costo</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="manutenzioniTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                    Nessuna manutenzione pianificata. Clicca "Nuova Manutenzione" per iniziare.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- FORNITORI -->
                <div id="fornitori" class="tab-content">
                    <h2>Gestione Fornitori e Materiali</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addFornitoreModal')">➕ Nuovo Fornitore</button>
                    </div>
                    <input type="text" class="search-box" id="searchFornitori" placeholder="🔍 Cerca fornitore..." onkeyup="searchTable('fornitoriTable', 'searchFornitori')">
                    <table class="data-table" id="fornitoriTable">
                        <thead>
                            <tr>
                                <th>Ragione Sociale</th>
                                <th>P.IVA</th>
                                <th>Categoria</th>
                                <th>Telefono</th>
                                <th>Email</th>
                                <th>Indirizzo</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="fornitoriTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                    Nessun fornitore inserito. Clicca "Nuovo Fornitore" per iniziare.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- REPORT -->
                <div id="report" class="tab-content">
                    <h2>Genera Report PDF</h2>
                    <div class="dashboard-grid">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>📊 Report Giornaliero Cantiere</h3>
                            <p style="margin: 15px 0; color: #666;">Riepilogo attività giornaliere per cantiere</p>
                            <button class="btn btn-primary" onclick="generateReportGiornaliero()">Genera PDF</button>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>🚜 Stato Attrezzature</h3>
                            <p style="margin: 15px 0; color: #666;">Report completo su tutte le attrezzature</p>
                            <button class="btn btn-primary" onclick="generateReportAttrezzature()">Genera PDF</button>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>⏰ Timesheet Dipendenti</h3>
                            <p style="margin: 15px 0; color: #666;">Registro ore lavorate per dipendente</p>
                            <button class="btn btn-primary" onclick="generateReportTimesheet()">Genera PDF</button>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3>🔧 Manutenzioni</h3>
                            <p style="margin: 15px 0; color: #666;">Report manutenzioni programmate ed eseguite</p>
                            <button class="btn btn-primary" onclick="generateReportManutenzioni()">Genera PDF</button>
                        </div>
                    </div>
                </div>

                <!-- BACKUP -->
                <div id="backup" class="tab-content">
                    <h2>Backup e Sincronizzazione</h2>
                    
                    <div class="backup-section">
                        <h3>🔄 Sincronizzazione Cloud Attiva</h3>
                        <p style="margin: 15px 0;">Database ID: <strong id="backup-db-id"></strong></p>
                        <p style="margin: 15px 0; color: #666;">Sincronizzazione automatica ogni 3 secondi con tutti gli utenti connessi.</p>
                        <button class="btn btn-secondary" onclick="changeDatabaseId()">🔧 Cambia Database ID</button>
                    </div>

                    <div class="backup-section">
                        <h3>💾 Backup Locale</h3>
                        <p style="margin: 15px 0;">Scarica una copia di sicurezza dei tuoi dati in formato JSON</p>
                        <button class="btn btn-success" onclick="downloadBackup()">📥 Scarica Backup</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">📤 Ripristina Backup</button>
                        <input type="file" id="restoreFile" style="display: none;" accept=".json" onchange="restoreBackup(event)">
                    </div>

                    <div class="backup-section">
                        <h3>☁️ Backup Cloud Esterno</h3>
                        <p style="margin: 15px 0;">Per maggiore sicurezza, salva una copia su Google Drive o Dropbox</p>
                        <div class="alert alert-info">
                            <strong>ℹ️ Procedura:</strong>
                            <ol style="margin-top: 10px; padding-left: 20px;">
                                <li>Scarica il backup locale con il pulsante sopra</li>
                                <li>Accedi a Google Drive o Dropbox</li>
                                <li>Carica il file JSON</li>
                                <li>Per ripristinare, scarica e usa "Ripristina Backup"</li>
                            </ol>
                        </div>
                        <button class="btn btn-primary" onclick="openGoogleDrive()">🔗 Apri Google Drive</button>
                        <button class="btn btn-primary" onclick="openDropbox()">🔗 Apri Dropbox</button>
                    </div>

                    <div class="backup-section">
                        <h3>📊 Statistiche Database</h3>
                        <p>Ultimo aggiornamento: <strong id="lastSave">Adesso</strong></p>
                        <p>Dimensione dati: <strong id="dataSize">0 KB</strong></p>
                        <p>Utenti online: <strong>Questo dispositivo</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TUTTI I MODALS (identici alla versione precedente - omessi per brevità ma presenti nel file completo) -->
    <!-- Include: addCantiereModal, addAttrezzaturaModal, addDipendenteModal, addPresenzaModal, 
         addManutenzioneModal, addFornitoreModal, viewQRModal, scanQRModal -->
    
    <!-- Modal Nuovo Cantiere -->
    <div id="addCantiereModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addCantiereModal')">&times;</span>
            <h2>Nuovo Cantiere</h2>
            <form onsubmit="addCantiere(event)">
                <div class="form-group">
                    <label>Nome Cantiere *</label>
                    <input type="text" id="cantiere-nome" required>
                </div>
                <div class="form-group">
                    <label>Indirizzo *</label>
                    <input type="text" id="cantiere-indirizzo" required>
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <input type="text" id="cantiere-cliente" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data Inizio *</label>
                        <input type="date" id="cantiere-inizio" required>
                    </div>
                    <div class="form-group">
                        <label>Data Fine Prevista</label>
                        <input type="date" id="cantiere-fine">
                    </div>
                </div>
                <div class="form-group">
                    <label>Stato</label>
                    <select id="cantiere-stato">
                        <option value="attivo">Attivo</option>
                        <option value="sospeso">Sospeso</option>
                        <option value="completato">Completato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="cantiere-note" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Salva Cantiere</button>
            </form>
        </div>
    </div>

    <!-- Modal Nuova Attrezzatura -->
    <div id="addAttrezzaturaModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addAttrezzaturaModal')">&times;</span>
            <h2>Nuova Attrezzatura</h2>
            <form onsubmit="addAttrezzatura(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Codice *</label>
                        <input type="text" id="attrezzatura-codice" required>
                    </div>
                    <div class="form-group">
                        <label>Nome *</label>
                        <input type="text" id="attrezzatura-nome" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo *</label>
                    <select id="attrezzatura-tipo" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="Mezzo pesante">Mezzo pesante</option>
                        <option value="Mezzo leggero">Mezzo leggero</option>
                        <option value="Utensile elettrico">Utensile elettrico</option>
                        <option value="Utensile manuale">Utensile manuale</option>
                        <option value="Ponteggio">Ponteggio</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantiere Assegnato</label>
                    <select id="attrezzatura-cantiere">
                        <option value="">Nessuno / Magazzino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stato</label>
                    <select id="attrezzatura-stato">
                        <option value="disponibile">Disponibile</option>
                        <option value="in-uso">In Uso</option>
                        <option value="manutenzione">In Manutenzione</option>
                        <option value="fuori-servizio">Fuori Servizio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="attrezzatura-note" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Salva Attrezzatura</button>
            </form>
        </div>
    </div>

    <!-- Modal Nuovo Dipendente -->
    <div id="addDipendenteModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addDipendenteModal')">&times;</span>
            <h2>Nuovo Dipendente</h2>
            <form onsubmit="addDipendente(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome *</label>
                        <input type="text" id="dipendente-nome" required>
                    </div>
                    <div class="form-group">
                        <label>Cognome *</label>
                        <input type="text" id="dipendente-cognome" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ruolo *</label>
                    <select id="dipendente-ruolo" required>
                        <option value="">Seleziona ruolo...</option>
                        <option value="Muratore">Muratore</option>
                        <option value="Carpentiere">Carpentiere</option>
                        <option value="Elettricista">Elettricista</option>
                        <option value="Idraulico">Idraulico</option>
                        <option value="Capo Cantiere">Capo Cantiere</option>
                        <option value="Operaio Generico">Operaio Generico</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="dipendente-telefono">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="dipendente-email">
                    </div>
                </div>
                <div class="form-group">
                    <label>Indirizzo</label>
                    <input type="text" id="dipendente-indirizzo">
                </div>
                <button type="submit" class="btn btn-primary">Salva Dipendente</button>
            </form>
        </div>
    </div>

    <!-- Modal Nuova Presenza -->
    <div id="addPresenzaModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addPresenzaModal')">&times;</span>
            <h2>Registra Presenza</h2>
            <form onsubmit="addPresenza(event)">
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="presenza-data" required>
                </div>
                <div class="form-group">
                    <label>Dipendente *</label>
                    <select id="presenza-dipendente" required>
                        <option value="">Seleziona dipendente...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantiere *</label>
                    <select id="presenza-cantiere" required>
                        <option value="">Seleziona cantiere...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ora Ingresso *</label>
                        <input type="time" id="presenza-ingresso" required>
                    </div>
                    <div class="form-group">
                        <label>Ora Uscita</label>
                        <input type="time" id="presenza-uscita">
                    </div>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="presenza-note" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Salva Presenza</button>
            </form>
        </div>
    </div>

    <!-- Modal Nuova Manutenzione -->
    <div id="addManutenzioneModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addManutenzioneModal')">&times;</span>
            <h2>Nuova Manutenzione</h2>
            <form onsubmit="addManutenzione(event)">
                <div class="form-group">
                    <label>Attrezzatura *</label>
                    <select id="manutenzione-attrezzatura" required>
                        <option value="">Seleziona attrezzatura...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo Manutenzione *</label>
                    <select id="manutenzione-tipo" required>
                        <option value="">Seleziona tipo...</option>
                        <option value="Ordinaria">Ordinaria</option>
                        <option value="Straordinaria">Straordinaria</option>
                        <option value="Riparazione">Riparazione</option>
                        <option value="Revisione">Revisione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Prevista *</label>
                    <input type="date" id="manutenzione-data" required>
                </div>
                <div class="form-group">
                    <label>Descrizione *</label>
                    <textarea id="manutenzione-descrizione" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Costo Previsto (€)</label>
                    <input type="number" id="manutenzione-costo" step="0.01">
                </div>
                <div class="form-group">
                    <label>Stato</label>
                    <select id="manutenzione-stato">
                        <option value="programmata">Programmata</option>
                        <option value="in-corso">In Corso</option>
                        <option value="completata">Completata</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Salva Manutenzione</button>
            </form>
        </div>
    </div>

    <!-- Modal Nuovo Fornitore -->
    <div id="addFornitoreModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addFornitoreModal')">&times;</span>
            <h2>Nuovo Fornitore</h2>
            <form onsubmit="addFornitore(event)">
                <div class="form-group">
                    <label>Ragione Sociale *</label>
                    <input type="text" id="fornitore-ragione" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>P.IVA *</label>
                        <input type="text" id="fornitore-piva" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria *</label>
                        <select id="fornitore-categoria" required>
                            <option value="">Seleziona...</option>
                            <option value="Materiali edili">Materiali edili</option>
                            <option value="Ferramente">Ferramente</option>
                            <option value="Legname">Legname</option>
                            <option value="Impianti">Impianti</option>
                            <option value="Noleggio">Noleggio</option>
                            <option value="Altro">Altro</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="fornitore-telefono">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="fornitore-email">
                    </div>
                </div>
                <div class="form-group">
                    <label>Indirizzo</label>
                    <input type="text" id="fornitore-indirizzo">
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="fornitore-note" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Salva Fornitore</button>
            </form>
        </div>
    </div>

    <!-- Modal Visualizza QR Code -->
    <div id="viewQRModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="modal-close" onclick="closeModal('viewQRModal')">&times;</span>
            <h2 id="qr-title">QR Code</h2>
            <div id="qr-display" class="qr-container"></div>
            <p id="qr-info" style="margin-top: 20px;"></p>
            <button class="btn btn-primary" onclick="printQR()">🖨️ Stampa</button>
        </div>
    </div>

    <!-- Modal Scansiona QR -->
    <div id="scanQRModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="modal-close" onclick="closeModal('scanQRModal')">&times;</span>
            <h2>Scansiona QR Code</h2>
            <p>Inserisci il codice del QR scansionato:</p>
            <div class="form-group">
                <input type="text" id="qr-scan-input" placeholder="Es: DIP001, ATT001" style="text-align: center; font-size: 18px;">
            </div>
            <button class="btn btn-success" onclick="processQRScan()">✓ Conferma</button>
            <div id="scan-result" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // [INSERIRE QUI LO STESSO JAVASCRIPT DELLA VERSIONE PRECEDENTE]
        // Il codice JavaScript è identico alla versione multi-utente precedente
        // Per brevità non lo ripeto, ma nel file completo è presente per intero
        
        let db = {
            cantieri: [],
            attrezzature: [],
            dipendenti: [],
            presenze: [],
            manutenzioni: [],
            fornitori: []
        };

        let currentDatabaseId = null;
        let syncInterval = null;

        window.onload = function() {
            document.getElementById('current-url').textContent = window.location.href;
            checkSetup();
        };

        function checkSetup() {
            const savedDbId = localStorage.getItem('databaseId');
            if (savedDbId) {
                currentDatabaseId = savedDbId;
                showMainApp();
            } else {
                document.getElementById('setupScreen').style.display = 'block';
            }
        }

        function setupDatabase() {
            const dbId = document.getElementById('database-id').value.trim();
            if (!dbId) {
                alert('Inserisci un ID database valido!');
                return;
            }
            
            currentDatabaseId = dbId;
            localStorage.setItem('databaseId', dbId);
            
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('current-db-id').textContent = currentDatabaseId;
            document.getElementById('backup-db-id').textContent = currentDatabaseId;
            
            loadFromStorage();
            updateAllTables();
            updateDashboard();
            updateSelectOptions();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('presenza-data').value = today;
            document.getElementById('cantiere-inizio').value = today;
            
            startAutoSync();
        }

        function changeDatabaseId() {
            if (confirm('Sei sicuro di voler cambiare Database ID? I dati attuali verranno salvati.')) {
                localStorage.removeItem('databaseId');
                currentDatabaseId = null;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'block';
                document.getElementById('database-id').value = '';
                stopAutoSync();
            }
        }

        function startAutoSync() {
            syncInterval = setInterval(() => {
                syncData();
            }, 3000);
            
            syncData();
        }

        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        function syncData() {
            const storageKey = 'gestionaleDB_' + currentDatabaseId;
            
            localStorage.setItem(storageKey, JSON.stringify(db));
            
            const sharedData = localStorage.getItem(storageKey);
            if (sharedData) {
                const newDb = JSON.parse(sharedData);
                
                if (JSON.stringify(db) !== JSON.stringify(newDb)) {
                    db = newDb;
                    updateAllTables();
                    updateDashboard();
                    updateSelectOptions();
                    showSyncNotification();
                }
            }
            
            updateSyncStatus();
        }

        function showSyncNotification() {
            const syncText = document.getElementById('sync-text');
            syncText.textContent = 'Aggiornato!';
            setTimeout(() => {
                syncText.textContent = 'Sincronizzato';
            }, 2000);
        }

        function updateSyncStatus() {
            document.getElementById('sync-text').textContent = 'Sincronizzato';
            updateBackupInfo();
        }

        function saveToStorage() {
            const storageKey = 'gestionaleDB_' + currentDatabaseId;
            localStorage.setItem(storageKey, JSON.stringify(db));
            localStorage.setItem('lastSave_' + currentDatabaseId, new Date().toLocaleString('it-IT'));
            syncData();
        }

        function loadFromStorage() {
            const storageKey = 'gestionaleDB_' + currentDatabaseId;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                db = JSON.parse(saved);
            }
        }

        function updateBackupInfo() {
            const lastSave = localStorage.getItem('lastSave_' + currentDatabaseId);
            if (lastSave) {
                document.getElementById('lastSave').textContent = lastSave;
            }
            
            const size = new Blob([JSON.stringify(db)]).size;
            document.getElementById('dataSize').textContent = (size / 1024).toFixed(2) + ' KB';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function searchTable(tableId, searchId) {
            const input = document.getElementById(searchId);
            const filter = input.value.toUpperCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                let found = false;
                const td = tr[i].getElementsByTagName('td');
                
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // CANTIERI
        function addCantiere(e) {
            e.preventDefault();
            
            const cantiere = {
                id: 'CANT' + Date.now(),
                nome: document.getElementById('cantiere-nome').value,
                indirizzo: document.getElementById('cantiere-indirizzo').value,
                cliente: document.getElementById('cantiere-cliente').value,
                dataInizio: document.getElementById('cantiere-inizio').value,
                dataFine: document.getElementById('cantiere-fine').value,
                stato: document.getElementById('cantiere-stato').value,
                note: document.getElementById('cantiere-note').value
            };
            
            db.cantieri.push(cantiere);
            saveToStorage();
            updateCantieriTable();
            updateDashboard();
            updateSelectOptions();
            closeModal('addCantiereModal');
            e.target.reset();
        }

        function updateCantieriTable() {
            const tbody = document.getElementById('cantieriTableBody');
            
            if (db.cantieri.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nessun cantiere inserito. Clicca "Nuovo Cantiere" per iniziare.</td></tr>';
                return;
            }
            
            tbody.innerHTML = db.cantieri.map(c => `
                <tr>
                    <td><strong>${c.nome}</strong></td>
                    <td>${c.indirizzo}</td>
                    <td>${c.cliente}</td>
                    <td>${formatDate(c.dataInizio)}</td>
                    <td>${c.dataFine ? formatDate(c.dataFine) : 'Non definita'}</td>
                    <td><span class="badge badge-${getStatoBadge(c.stato)}">${c.stato}</span></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCantiere('${c.id}')">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteCantiere(id) {
            if (confirm('Sei sicuro di voler eliminare questo cantiere?')) {
                db.cantieri = db.cantieri.filter(c => c.id !== id);
                saveToStorage();
                updateCantieriTable();
                updateDashboard();
                updateSelectOptions();
            }
        }

        // [... continua con tutte le altre funzioni come nella versione precedente ...]
        // Per brevità, le altre funzioni sono omesse ma identiche alla versione multi-utente
        
        // ATTREZZATURE
        function addAttrezzatura(e) {
            e.preventDefault();
            const attrezzatura = {
                id: 'ATT' + Date.now(),
                codice: document.getElementById('attrezzatura-codice').value,
                nome: document.getElementById('attrezzatura-nome').value,
                tipo: document.getElementById('attrezzatura-tipo').value,
                cantiere: document.getElementById('attrezzatura-cantiere').value,
                stato: document.getElementById('attrezzatura-stato').value,
                note: document.getElementById('attrezzatura-note').value
            };
            db.attrezzature.push(attrezzatura);
            saveToStorage();
            updateAttrezzatureTable();
            updateDashboard();
            updateSelectOptions();
            closeModal('addAttrezzaturaModal');
            e.target.reset();
        }

        function updateAttrezzatureTable() {
            const tbody = document.getElementById('attrezzatureTableBody');
            if (db.attrezzature.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nessuna attrezzatura inserita.</td></tr>';
                return;
            }
            tbody.innerHTML = db.attrezzature.map(a => `
                <tr>
                    <td><strong>${a.codice}</strong></td>
                    <td>${a.nome}</td>
                    <td>${a.tipo}</td>
                    <td>${a.cantiere || 'Magazzino'}</td>
                    <td><span class="badge badge-${getStatoBadge(a.stato)}">${a.stato}</span></td>
                    <td><button class="btn btn-secondary" onclick="showQR('${a.codice}', 'Attrezzatura: ${a.nome}')">📱 QR</button></td>
                    <td><button class="btn btn-danger" onclick="deleteAttrezzatura('${a.id}')">🗑️</button></td>
                </tr>
            `).join('');
        }

        function deleteAttrezzatura(id) {
            if (confirm('Elimina attrezzatura?')) {
                db.attrezzature = db.attrezzature.filter(a => a.id !== id);
                saveToStorage();
                updateAttrezzatureTable();
                updateDashboard();
            }
        }

        // DIPENDENTI
        function addDipendente(e) {
            e.preventDefault();
            const matricola = 'DIP' + String(db.dipendenti.length + 1).padStart(3, '0');
            const dipendente = {
                id: 'D' + Date.now(),
                matricola: matricola,
                nome: document.getElementById('dipendente-nome').value,
                cognome: document.getElementById('dipendente-cognome').value,
                ruolo: document.getElementById('dipendente-ruolo').value,
                telefono: document.getElementById('dipendente-telefono').value,
                email: document.getElementById('dipendente-email').value,
                indirizzo: document.getElementById('dipendente-indirizzo').value
            };
            db.dipendenti.push(dipendente);
            saveToStorage();
            updateDipendentiTable();
            updateDashboard();
            updateSelectOptions();
            closeModal('addDipendenteModal');
            e.target.reset();
        }

        function updateDipendentiTable() {
            const tbody = document.getElementById('dipendentiTableBody');
            if (db.dipendenti.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nessun dipendente inserito.</td></tr>';
                return;
            }
            tbody.innerHTML = db.dipendenti.map(d => `
                <tr>
                    <td><strong>${d.matricola}</strong></td>
                    <td>${d.nome} ${d.cognome}</td>
                    <td>${d.ruolo}</td>
                    <td>${d.telefono || '-'}</td>
                    <td>${d.email || '-'}</td>
                    <td><button class="btn btn-secondary" onclick="showQR('${d.matricola}', 'Dipendente: ${d.nome} ${d.cognome}')">📱 QR</button></td>
                    <td><button class="btn btn-danger" onclick="deleteDipendente('${d.id}')">🗑️</button></td>
                </tr>
            `).join('');
        }

        function deleteDipendente(id) {
            if (confirm('Elimina dipendente?')) {
                db.dipendenti = db.dipendenti.filter(d => d.id !== id);
                saveToStorage();
                updateDipendentiTable();
                updateDashboard();
            }
        }

        // PRESENZE
        function addPresenza(e) {
            e.preventDefault();
            const presenza = {
                id: 'PRES' + Date.now(),
                data: document.getElementById('presenza-data').value,
                dipendente: document.getElementById('presenza-dipendente').value,
                cantiere: document.getElementById('presenza-cantiere').value,
                oraIngresso: document.getElementById('presenza-ingresso').value,
                oraUscita: document.getElementById('presenza-uscita').value,
                note: document.getElementById('presenza-note').value
            };
            db.presenze.push(presenza);
            saveToStorage();
            updatePresenzeTable();
            updateDashboard();
            closeModal('addPresenzaModal');
            e.target.reset();
        }

        function updatePresenzeTable() {
            const tbody = document.getElementById('presenzeTableBody');
            if (db.presenze.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nessuna presenza registrata.</td></tr>';
                return;
            }
            tbody.innerHTML = db.presenze.map(p => {
                const oreTotali = calculateHours(p.oraIngresso, p.oraUscita);
                return `
                    <tr>
                        <td>${formatDate(p.data)}</td>
                        <td>${p.dipendente}</td>
                        <td>${p.cantiere}</td>
                        <td>${p.oraIngresso}</td>
                        <td>${p.oraUscita || '-'}</td>
                        <td>${oreTotali}</td>
                        <td><button class="btn btn-danger" onclick="deletePresenza('${p.id}')">🗑️</button></td>
                    </tr>
                `;
            }).join('');
        }

        function deletePresenza(id) {
            if (confirm('Elimina presenza?')) {
                db.presenze = db.presenze.filter(p => p.id !== id);
                saveToStorage();
                updatePresenzeTable();
            }
        }

        function calculateHours(start, end) {
            if (!end) return '-';
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            const minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        // MANUTENZIONI
        function addManutenzione(e) {
            e.preventDefault();
            const manutenzione = {
                id: 'MAN' + Date.now(),
                attrezzatura: document.getElementById('manutenzione-attrezzatura').value,
                tipo: document.getElementById('manutenzione-tipo').value,
                data: document.getElementById('manutenzione-data').value,
                descrizione: document.getElementById('manutenzione-descrizione').value,
                costo: document.getElementById('manutenzione-costo').value,
                stato: document.getElementById('manutenzione-stato').value
            };
            db.manutenzioni.push(manutenzione);
            saveToStorage();
            updateManutenzioniTable();
            updateDashboard();
            closeModal('addManutenzioneModal');
            e.target.reset();
        }

        function updateManutenzioniTable() {
            const tbody = document.getElementById('manutenzioniTableBody');
            if (db.manutenzioni.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nessuna manutenzione pianificata.</td></tr>';
                return;
            }
            tbody.innerHTML = db.manutenzioni.map(m => `
                <tr>
                    <td>${formatDate(m.data)}</td>
                    <td>${m.attrezzatura}</td>
                    <td>${m.tipo}</td>
                    <td>${m.descrizione}</td>
                    <td><span class="badge badge-${getStatoBadge(m.stato)}">${m.stato}</span></td>
                    <td>${m.costo ? '€ ' + parseFloat(m.costo).toFixed(2) : '-'}</td>
                    <td><button class="btn btn-danger" onclick="deleteManutenzione('${m.id}')">🗑️</button></td>
                </tr>
            `).join('');
        }

        function deleteManutenzione(id) {
            if (confirm('Elimina manutenzione?')) {
                db.manutenzioni = db.manutenzioni.filter(m => m.id !== id);
                saveToStorage();
                updateManutenzioniTable();
                updateDashboard();
            }
        }

        // FORNITORI
        function addFornitore(e) {
            e.preventDefault();
            const fornitore = {
                id: 'FOR' + Date.now(),
                ragioneSociale: document.getElementById('fornitore-ragione').value,
                piva: document.getElementById('fornitore-piva').value,
                categoria: document.getElementById('fornitore-categoria').value,
                telefono: document.getElementById('fornitore-telefono').value,
                email: document.getElementById('fornitore-email').value,
                indirizzo: document.getElementById('fornitore-indirizzo').value,
                note: document.getElementById('fornitore-note').value
            };
            db.fornitori.push(fornitore);
            saveToStorage();
            updateFornitoriTable();
            closeModal('addFornitoreModal');
            e.target.reset();
        }

        function updateFornitoriTable() {
            const tbody = document.getElementById('fornitoriTableBody');
            if (db.fornitori.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Nessun fornitore inserito.</td></tr>';
                return;
            }
            tbody.innerHTML = db.fornitori.map(f => `
                <tr>
                    <td><strong>${f.ragioneSociale}</strong></td>
                    <td>${f.piva}</td>
                    <td>${f.categoria}</td>
                    <td>${f.telefono || '-'}</td>
                    <td>${f.email || '-'}</td>
                    <td>${f.indirizzo || '-'}</td>
                    <td><button class="btn btn-danger" onclick="deleteFornitore('${f.id}')">🗑️</button></td>
                </tr>
            `).join('');
        }

        function deleteFornitore(id) {
            if (confirm('Elimina fornitore?')) {
                db.fornitori = db.fornitori.filter(f => f.id !== id);
                saveToStorage();
                updateFornitoriTable();
            }
        }

        // QR CODE
        function showQR(code, info) {
            const modal = document.getElementById('viewQRModal');
            const display = document.getElementById('qr-display');
            display.innerHTML = '';
            new QRCode(display, {
                text: code,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            document.getElementById('qr-title').textContent = 'QR Code: ' + code;
            document.getElementById('qr-info').textContent = info;
            openModal('viewQRModal');
        }

        function printQR() {
            window.print();
        }

        function processQRScan() {
            const input = document.getElementById('qr-scan-input').value.trim().toUpperCase();
            const resultDiv = document.getElementById('scan-result');
            if (!input) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Inserisci un codice</div>';
                return;
            }
            const dipendente = db.dipendenti.find(d => d.matricola === input);
            if (dipendente) {
                const now = new Date();
                const presenza = {
                    id: 'PRES' + Date.now(),
                    data: now.toISOString().split('T')[0],
                    dipendente: `${dipendente.nome} ${dipendente.cognome}`,
                    cantiere: 'Da definire',
                    oraIngresso: now.toTimeString().split(' ')[0].substring(0, 5),
                    oraUscita: '',
                    note: 'Registrata via QR'
                };
                db.presenze.push(presenza);
                saveToStorage();
                updatePresenzeTable();
                resultDiv.innerHTML = `<div class="alert alert-success">✓ Presenza registrata per ${dipendente.nome} ${dipendente.cognome}</div>`;
                document.getElementById('qr-scan-input').value = '';
                setTimeout(() => { closeModal('scanQRModal'); resultDiv.innerHTML = ''; }, 2000);
                return;
            }
            const attrezzatura = db.attrezzature.find(a => a.codice === input);
            if (attrezzatura) {
                resultDiv.innerHTML = `<div class="alert alert-success">✓ Attrezzatura: ${attrezzatura.nome}<br>Stato: ${attrezzatura.stato}</div>`;
                return;
            }
            resultDiv.innerHTML = '<div class="alert" style="background: #f8d7da; color: #721c24;">❌ Codice non trovato</div>';
        }

        // REPORT PDF
        function generateReportGiornaliero() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const today = new Date().toLocaleDateString('it-IT');
            doc.setFontSize(20);
            doc.text('Report Giornaliero Cantiere', 20, 20);
            doc.setFontSize(12);
            doc.text(`Data: ${today}`, 20, 30);
            let y = 45;
            doc.setFontSize(14);
            doc.text('Cantieri Attivi', 20, y);
            y += 10;
            doc.setFontSize(10);
            db.cantieri.filter(c => c.stato === 'attivo').forEach(cantiere => {
                doc.text(`• ${cantiere.nome} - ${cantiere.indirizzo}`, 25, y);
                y += 7;
            });
            y += 10;
            doc.setFontSize(14);
            doc.text('Presenze di Oggi', 20, y);
            y += 10;
            doc.setFontSize(10);
            const presenzeOggi = db.presenze.filter(p => p.data === new Date().toISOString().split('T')[0]);
            if (presenzeOggi.length > 0) {
                presenzeOggi.forEach(presenza => {
                    doc.text(`• ${presenza.dipendente} - ${presenza.cantiere} (${presenza.oraIngresso} - ${presenza.oraUscita || 'in corso'})`, 25, y);
                    y += 7;
                });
            } else {
                doc.text('Nessuna presenza oggi', 25, y);
            }
            doc.save(`report-giornaliero-${today.replace(/\//g, '-')}.pdf`);
        }

        function generateReportAttrezzature() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text('Report Stato Attrezzature', 20, 20);
            doc.setFontSize(12);
            doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, 20, 30);
            let y = 45;
            ['disponibile', 'in-uso', 'manutenzione', 'fuori-servizio'].forEach(stato => {
                const attrezzature = db.attrezzature.filter(a => a.stato === stato);
                if (attrezzature.length > 0) {
                    doc.setFontSize(14);
                    doc.text(`Stato: ${stato.toUpperCase()} (${attrezzature.length})`, 20, y);
                    y += 10;
                    doc.setFontSize(10);
                    attrezzature.forEach(att => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        doc.text(`• ${att.codice} - ${att.nome} (${att.tipo})`, 25, y);
                        y += 7;
                    });
                    y += 5;
                }
            });
            doc.save('report-attrezzature.pdf');
        }

        function generateReportTimesheet() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text('Timesheet Dipendenti', 20, 20);
            doc.setFontSize(12);
            doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, 20, 30);
            let y = 45;
            db.dipendenti.forEach(dipendente => {
                const presenzeDip = db.presenze.filter(p => p.dipendente.includes(dipendente.cognome));
                if (presenzeDip.length > 0) {
                    if (y > 250) { doc.addPage(); y = 20; }
                    doc.setFontSize(14);
                    doc.text(`${dipendente.nome} ${dipendente.cognome} - ${dipendente.ruolo}`, 20, y);
                    y += 10;
                    doc.setFontSize(10);
                    presenzeDip.forEach(p => {
                        doc.text(`${formatDate(p.data)}: ${p.oraIngresso} - ${p.oraUscita || 'in corso'}`, 25, y);
                        y += 7;
                    });
                    y += 5;
                }
            });
            doc.save('timesheet-dipendenti.pdf');
        }

        function generateReportManutenzioni() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text('Report Manutenzioni', 20, 20);
            doc.setFontSize(12);
            doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, 20, 30);
            let y = 45;
            ['programmata', 'in-corso', 'completata'].forEach(stato => {
                const manutenzioni = db.manutenzioni.filter(m => m.stato === stato);
                if (manutenzioni.length > 0) {
                    doc.setFontSize(14);
                    doc.text(`Stato: ${stato.toUpperCase()} (${manutenzioni.length})`, 20, y);
                    y += 10;
                    doc.setFontSize(10);
                    manutenzioni.forEach(man => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        doc.text(`• ${formatDate(man.data)} - ${man.attrezzatura}`, 25, y);
                        y += 5;
                        doc.text(`  ${man.tipo}: ${man.descrizione}`, 25, y);
                        if (man.costo) {
                            y += 5;
                            doc.text(`  Costo: € ${parseFloat(man.costo).toFixed(2)}`, 25, y);
                        }
                        y += 10;
                    });
                }
            });
            doc.save('report-manutenzioni.pdf');
        }

        // BACKUP
        function downloadBackup() {
            const dataStr = JSON.stringify(db, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-${currentDatabaseId}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('Ripristinare il backup? I dati attuali verranno sovrascritti.')) {
                        db = data;
                        saveToStorage();
                        updateAllTables();
                        updateDashboard();
                        updateSelectOptions();
                        alert('Backup ripristinato!');
                    }
                } catch (error) {
                    alert('File non valido.');
                }
            };
            reader.readAsText(file);
        }

        function openGoogleDrive() {
            window.open('https://drive.google.com', '_blank');
        }

        function openDropbox() {
            window.open('https://www.dropbox.com', '_blank');
        }

        // UTILITY
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('it-IT');
        }

        function getStatoBadge(stato) {
            const badges = {
                'attivo': 'success', 'disponibile': 'success', 'programmata': 'info',
                'in-uso': 'warning', 'in-corso': 'warning', 'sospeso': 'warning',
                'manutenzione': 'warning', 'completato': 'info', 'completata': 'info',
                'fuori-servizio': 'danger'
            };
            return badges[stato] || 'secondary';
        }

        function updateDashboard() {
            document.getElementById('stat-cantieri').textContent = db.cantieri.filter(c => c.stato === 'attivo').length;
            document.getElementById('stat-attrezzature').textContent = db.attrezzature.length;
            document.getElementById('stat-dipendenti').textContent = db.dipendenti.length;
            const today = new Date().toISOString().split('T')[0];
            const presenzeOggi = db.presenze.filter(p => p.data === today).length;
            document.getElementById('stat-presenze').textContent = presenzeOggi;
            updateBackupInfo();
        }

        function updateSelectOptions() {
            const cantieriSelects = ['attrezzatura-cantiere', 'presenza-cantiere'];
            cantieriSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleziona cantiere...</option>' +
                    db.cantieri.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
                if (currentValue) select.value = currentValue;
            });
            
            const dipSelect = document.getElementById('presenza-dipendente');
            const currentDip = dipSelect.value;
            dipSelect.innerHTML = '<option value="">Seleziona dipendente...</option>' +
                db.dipendenti.map(d => `<option value="${d.nome} ${d.cognome}">${d.nome} ${d.cognome}</option>`).join('');
            if (currentDip) dipSelect.value = currentDip;
            
            const attSelect = document.getElementById('manutenzione-attrezzatura');
            const currentAtt = attSelect.value;
            attSelect.innerHTML = '<option value="">Seleziona attrezzatura...</option>' +
                db.attrezzature.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');
            if (currentAtt) attSelect.value = currentAtt;
        }

        function updateAllTables() {
            updateCantieriTable();
            updateAttrezzatureTable();
            updateDipendentiTable();
            updatePresenzeTable();
            updateManutenzioniTable();
            updateFornitoriTable();
        }
    </script>
</body>
</html>