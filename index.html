<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Edile Pro - Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Login Screen Styles */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-box h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            margin-top: 20px;
            font-size: 14px;
        }
        
        /* Main App Styles */
        #mainApp {
            display: none;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            white-space: nowrap;
        }
        
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active { color: #667eea; border-bottom-color: #667eea; background: white; }
        
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .data-table th, .data-table td { padding: 15px; text-align: left; }
        .data-table tbody tr { border-bottom: 1px solid #f0f0f0; }
        .data-table tbody tr:hover { background: #f8f9fa; }
        
        .btn-primary {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-success { background: #28a745; padding: 8px 16px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-danger { background: #dc3545; padding: 8px 16px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-secondary { background: #6c757d; padding: 8px 16px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: #333; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-info { background: #17a2b8; color: white; }
        .badge-admin { background: #667eea; color: white; }
        .badge-user { background: #28a745; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .user-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-only { display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .search-box { width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 14px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>üèóÔ∏è Gestionale Edile Pro</h1>
            <div id="errorMsg"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">üîê Accedi</button>
            </form>
            <div class="alert alert-info">
                <strong>üìù Credenziali Iniziali:</strong><br>
                Username: <code>admin</code><br>
                Password: <code>edile2025</code>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <div class="container">
            <div class="header">
                <button class="logout-btn" onclick="handleLogout()">üö™ Esci</button>
                <h1>üèóÔ∏è Gestionale Edile Pro</h1>
                <p>Sistema Cloud Multi-Utente</p>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="nav-tab" onclick="switchTab('cantieri')">üèóÔ∏è Cantieri</button>
                <button class="nav-tab" onclick="switchTab('attrezzature')">üöú Attrezzature</button>
                <button class="nav-tab" onclick="switchTab('dipendenti')">üë∑ Dipendenti</button>
                <button class="nav-tab" onclick="switchTab('presenze')">‚è∞ Presenze</button>
                <button class="nav-tab" onclick="switchTab('manutenzioni')">üîß Manutenzioni</button>
                <button class="nav-tab" onclick="switchTab('fornitori')">üì¶ Fornitori</button>
                <button class="nav-tab" onclick="switchTab('report')">üìÑ Report</button>
                <button class="nav-tab admin-only" id="usersTab" onclick="switchTab('users')">üë• Gestione Utenti</button>
                <button class="nav-tab" onclick="switchTab('backup')">‚òÅÔ∏è Backup</button>
            </div>

            <div class="content">
                <!-- DASHBOARD -->
                <div id="dashboard" class="tab-content active">
                    <h2>Dashboard Generale</h2>
                    <div class="alert alert-success">
                        <strong>‚úì Connesso!</strong> Benvenuto <span id="welcomeUser"></span>!
                    </div>
                    <div class="dashboard-grid">
                        <div class="stat-card"><h3>Cantieri Attivi</h3><div class="number" id="stat-cantieri">0</div></div>
                        <div class="stat-card"><h3>Attrezzature</h3><div class="number" id="stat-attrezzature">0</div></div>
                        <div class="stat-card"><h3>Dipendenti</h3><div class="number" id="stat-dipendenti">0</div></div>
                        <div class="stat-card"><h3>Utenti Sistema</h3><div class="number" id="stat-utenti">1</div></div>
                    </div>
                </div>

                <!-- CANTIERI -->
                <div id="cantieri" class="tab-content">
                    <h2>Gestione Cantieri</h2>
                    <button class="btn-primary" onclick="openModal('addCantiereModal')">‚ûï Nuovo Cantiere</button>
                    <input type="text" class="search-box" id="searchCantieri" placeholder="üîç Cerca..." onkeyup="searchTable('cantieriTable', this.value)">
                    <table class="data-table" id="cantieriTable">
                        <thead><tr><th>Nome</th><th>Indirizzo</th><th>Cliente</th><th>Stato</th><th>Azioni</th></tr></thead>
                        <tbody id="cantieriBody"><tr><td colspan="5" style="text-align:center;padding:40px;">Nessun cantiere</td></tr></tbody>
                    </table>
                </div>

                <!-- ATTREZZATURE -->
                <div id="attrezzature" class="tab-content">
                    <h2>Gestione Attrezzature</h2>
                    <button class="btn-primary" onclick="openModal('addAttrezzaturaModal')">‚ûï Nuova Attrezzatura</button>
                    <table class="data-table">
                        <thead><tr><th>Codice</th><th>Nome</th><th>Tipo</th><th>Stato</th><th>Azioni</th></tr></thead>
                        <tbody id="attrezzatureBody"><tr><td colspan="5" style="text-align:center;padding:40px;">Nessuna attrezzatura</td></tr></tbody>
                    </table>
                </div>

                <!-- DIPENDENTI -->
                <div id="dipendenti" class="tab-content">
                    <h2>Gestione Dipendenti</h2>
                    <button class="btn-primary" onclick="openModal('addDipendenteModal')">‚ûï Nuovo Dipendente</button>
                    <table class="data-table">
                        <thead><tr><th>Matricola</th><th>Nome</th><th>Ruolo</th><th>Azioni</th></tr></thead>
                        <tbody id="dipendentiBody"><tr><td colspan="4" style="text-align:center;padding:40px;">Nessun dipendente</td></tr></tbody>
                    </table>
                </div>

                <!-- PRESENZE -->
                <div id="presenze" class="tab-content">
                    <h2>Registro Presenze</h2>
                    <button class="btn-primary" onclick="openModal('addPresenzaModal')">‚ûï Nuova Presenza</button>
                    <table class="data-table">
                        <thead><tr><th>Data</th><th>Dipendente</th><th>Cantiere</th><th>Ingresso</th><th>Uscita</th><th>Azioni</th></tr></thead>
                        <tbody id="presenzeBody"><tr><td colspan="6" style="text-align:center;padding:40px;">Nessuna presenza</td></tr></tbody>
                    </table>
                </div>

                <!-- MANUTENZIONI -->
                <div id="manutenzioni" class="tab-content">
                    <h2>Calendario Manutenzioni</h2>
                    <button class="btn-primary" onclick="openModal('addManutenzioneModal')">‚ûï Nuova Manutenzione</button>
                    <table class="data-table">
                        <thead><tr><th>Data</th><th>Attrezzatura</th><th>Tipo</th><th>Stato</th><th>Azioni</th></tr></thead>
                        <tbody id="manutenzioniBody"><tr><td colspan="5" style="text-align:center;padding:40px;">Nessuna manutenzione</td></tr></tbody>
                    </table>
                </div>

                <!-- FORNITORI -->
                <div id="fornitori" class="tab-content">
                    <h2>Gestione Fornitori</h2>
                    <button class="btn-primary" onclick="openModal('addFornitoreModal')">‚ûï Nuovo Fornitore</button>
                    <table class="data-table">
                        <thead><tr><th>Ragione Sociale</th><th>P.IVA</th><th>Categoria</th><th>Telefono</th><th>Azioni</th></tr></thead>
                        <tbody id="fornitoriBody"><tr><td colspan="5" style="text-align:center;padding:40px;">Nessun fornitore</td></tr></tbody>
                    </table>
                </div>

                <!-- REPORT -->
                <div id="report" class="tab-content">
                    <h2>Genera Report PDF</h2>
                    <div class="dashboard-grid">
                        <div style="background:white;padding:20px;border-radius:10px;"><h3>üìä Report Giornaliero</h3><p style="margin:15px 0;">Riepilogo attivit√†</p><button class="btn-primary">Genera PDF</button></div>
                        <div style="background:white;padding:20px;border-radius:10px;"><h3>üöú Stato Attrezzature</h3><p style="margin:15px 0;">Report completo</p><button class="btn-primary">Genera PDF</button></div>
                    </div>
                </div>

                <!-- GESTIONE UTENTI (solo admin) -->
                <div id="users" class="tab-content">
                    <h2>üë• Gestione Utenti del Sistema</h2>
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Pannello Amministratore</strong> - Gestisci gli utenti che possono accedere al gestionale
                    </div>
                    <button class="btn-primary" onclick="openModal('addUserModal')">‚ûï Aggiungi Nuovo Utente</button>
                    <h3 style="margin-top:30px;">Utenti Registrati:</h3>
                    <div id="usersList"></div>
                </div>

                <!-- BACKUP -->
                <div id="backup" class="tab-content">
                    <h2>‚òÅÔ∏è Backup e Sincronizzazione</h2>
                    <div style="background:white;padding:30px;border-radius:10px;margin-bottom:20px;">
                        <h3>üíæ Backup Locale</h3>
                        <p style="margin:15px 0;">Scarica copia dati in JSON</p>
                        <button class="btn-success" onclick="downloadBackup()">üì• Scarica Backup</button>
                        <button class="btn-secondary" onclick="document.getElementById('restoreFile').click()">üì§ Ripristina</button>
                        <input type="file" id="restoreFile" style="display:none;" accept=".json" onchange="restoreBackup(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="addCantiereModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addCantiereModal')">&times;</span>
            <h2>Nuovo Cantiere</h2>
            <form onsubmit="addCantiere(event)">
                <div class="form-group"><label>Nome *</label><input type="text" id="cantiere-nome" required></div>
                <div class="form-group"><label>Indirizzo *</label><input type="text" id="cantiere-indirizzo" required></div>
                <div class="form-group"><label>Cliente *</label><input type="text" id="cantiere-cliente" required></div>
                <div class="form-group"><label>Stato</label><select id="cantiere-stato"><option value="attivo">Attivo</option><option value="sospeso">Sospeso</option></select></div>
                <button type="submit" class="btn-primary">Salva</button>
            </form>
        </div>
    </div>

    <div id="addAttrezzaturaModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addAttrezzaturaModal')">&times;</span>
            <h2>Nuova Attrezzatura</h2>
            <form onsubmit="addAttrezzatura(event)">
                <div class="form-group"><label>Codice *</label><input type="text" id="attr-codice" required></div>
                <div class="form-group"><label>Nome *</label><input type="text" id="attr-nome" required></div>
                <div class="form-group"><label>Tipo</label><select id="attr-tipo"><option>Mezzo pesante</option><option>Utensile</option></select></div>
                <div class="form-group"><label>Stato</label><select id="attr-stato"><option value="disponibile">Disponibile</option><option value="in-uso">In Uso</option></select></div>
                <button type="submit" class="btn-primary">Salva</button>
            </form>
        </div>
    </div>

    <div id="addDipendenteModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addDipendenteModal')">&times;</span>
            <h2>Nuovo Dipendente</h2>
            <form onsubmit="addDipendente(event)">
                <div class="form-group"><label>Nome *</label><input type="text" id="dip-nome" required></div>
                <div class="form-group"><label>Cognome *</label><input type="text" id="dip-cognome" required></div>
                <div class="form-group"><label>Ruolo</label><select id="dip-ruolo"><option>Muratore</option><option>Carpentiere</option><option>Capo Cantiere</option></select></div>
                <button type="submit" class="btn-primary">Salva</button>
            </form>
        </div>
    </div>

    <div id="addPresenzaModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addPresenzaModal')">&times;</span>
            <h2>Nuova Presenza</h2>
            <form onsubmit="addPresenza(event)">
                <div class="form-group"><label>Data *</label><input type="date" id="pres-data" required></div>
                <div class="form-group"><label>Dipendente *</label><select id="pres-dipendente" required><option value="">Seleziona...</option></select></div>
                <div class="form-group"><label>Cantiere *</label><select id="pres-cantiere" required><option value="">Seleziona...</option></select></div>
                <div class="form-row">
                    <div class="form-group"><label>Ingresso *</label><input type="time" id="pres-ingresso" required></div>
                    <div class="form-group"><label>Uscita</label><input type="time" id="pres-uscita"></div>
                </div>
                <button type="submit" class="btn-primary">Salva</button>
            </form>
        </div>
    </div>

    <div id="addManutenzioneModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addManutenzioneModal')">&times;</span>
            <h2>Nuova Manutenzione</h2>
            <form onsubmit="addManutenzione(event)">
                <div class="form-group"><label>Attrezzatura *</label><select id="man-attr" required><option value="">Seleziona...</option></select></div>
                <div class="form-group"><label>Tipo</label><select id="man-tipo"><option>Ordinaria</option><option>Straordinaria</option></select></div>
                <div class="form-group"><label>Data *</label><input type="date" id="man-data" required></div>
                <div class="form-group"><label>Stato</label><select id="man-stato"><option value="programmata">Programmata</option><option value="completata">Completata</option></select></div>
                <button type="submit" class="btn-primary">Salva</button>
            </form>
        </div>
    </div>

    <div id="addFornitoreModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addFornitoreModal')">&times;</span>
            <h2>Nuovo Fornitore</h2>
            <form onsubmit="addFornitore(event)">
                <div class="form-group"><label>Ragione Sociale *</label><input type="text" id="forn-ragione" required></div>
                <div class="form-group"><label>P.IVA *</label><input type="text" id="forn-piva" required></div>
                <div class="form-group"><label>Categoria</label><select id="forn-categoria"><option>Materiali edili</option><option>Ferramenta</option><option>Noleggio</option></select></div>
                <div class="form-group"><label>Telefono</label><input type="tel" id="forn-tel"></div>
                <button type="submit" class="btn-primary">Salva</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>‚ûï Aggiungi Utente</h2>
            <div class="alert alert-info">L'utente potr√† accedere al gestionale con queste credenziali</div>
            <form onsubmit="addUser(event)">
                <div class="form-group"><label>Username *</label><input type="text" id="new-username" required minlength="4" placeholder="es: mario.rossi"></div>
                <div class="form-group"><label>Password *</label><input type="password" id="new-password" required minlength="6"></div>
                <div class="form-group">
                    <label>Ruolo *</label>
                    <select id="new-role" required>
                        <option value="user">üë§ Utente Standard</option>
                        <option value="admin">üëë Amministratore</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">‚úì Crea Utente</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = '';
        let currentRole = '';
        let db = { cantieri: [], attrezzature: [], dipendenti: [], presenze: [], manutenzioni: [], fornitori: [] };

        function getUsers() {
            const users = localStorage.getItem('gestionaleUsers');
            if (!users) {
                const defaultUsers = { 'admin': { password: hashPassword('edile2025'), role: 'admin' } };
                localStorage.setItem('gestionaleUsers', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
            return JSON.parse(users);
        }

        function saveUsers(users) {
            localStorage.setItem('gestionaleUsers', JSON.stringify(users));
        }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const users = getUsers();
            const user = users[username];

            if (user && user.password === hashPassword(password)) {
                currentUser = username;
                currentRole = user.role;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('welcomeUser').textContent = username;
                
                if (currentRole === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                    loadUsers();
                }
                
                loadData();
                updateDashboard();
            } else {
                document.getElementById('errorMsg').innerHTML = '<div class="alert alert-danger">‚ùå Credenziali non valide!</div>';
                setTimeout(() => document.getElementById('errorMsg').innerHTML = '', 3000);
            }
        }

        function handleLogout() {
            if (confirm('Vuoi uscire?')) location.reload();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function searchTable(tableId, searchValue) {
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName('tr');
            const filter = searchValue.toUpperCase();
            for (let i = 1; i < tr.length; i++) {
                let found = false;
                const td = tr[i].getElementsByTagName('td');
                for (let j = 0; j < td.length; j++) {
                    if (td[j] && td[j].textContent.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        function loadData() {
            const saved = localStorage.getItem('gestionaleDB_shared');
            if (saved) db = JSON.parse(saved);
            updateAllTables();
        }

        function saveData() {
            localStorage.setItem('gestionaleDB_shared', JSON.stringify(db));
        }

        function addCantiere(e) {
            e.preventDefault();
            db.cantieri.push({
                id: 'CANT' + Date.now(),
                nome: document.getElementById('cantiere-nome').value,
                indirizzo: document.getElementById('cantiere-indirizzo').value,
                cliente: document.getElementById('cantiere-cliente').value,
                stato: document.getElementById('cantiere-stato').value
            });
            saveData();
            updateAllTables();
            updateDashboard();
            closeModal('addCantiereModal');
            e.target.reset();
        }

        function addAttrezzatura(e) {
            e.preventDefault();
            db.attrezzature.push({
                id: 'ATT' + Date.now(),
                codice: document.getElementById('attr-codice').value,
                nome: document.getElementById('attr-nome').value,
                tipo: document.getElementById('attr-tipo').value,
                stato: document.getElementById('attr-stato').value
            });
            saveData();
            updateAllTables();
            closeModal('addAttrezzaturaModal');
            e.target.reset();
        }

        function addDipendente(e) {
            e.preventDefault();
            const matricola = 'DIP' + String(db.dipendenti.length + 1).padStart(3, '0');
            db.dipendenti.push({
                id: 'D' + Date.now(),
                matricola: matricola,
                nome: document.getElementById('dip-nome').value,
                cognome: document.getElementById('dip-cognome').value,
                ruolo: document.getElementById('dip-ruolo').value
            });
            saveData();
            updateAllTables();
            closeModal('addDipendenteModal');
            e.target.reset();
        }

        function addPresenza(e) {
            e.preventDefault();
            db.presenze.push({
                id: 'PRES' + Date.now(),
                data: document.getElementById('pres-data').value,
                dipendente: document.getElementById('pres-dipendente').value,
                cantiere: document.getElementById('pres-cantiere').value,
                oraIngresso: document.getElementById('pres-ingresso').value,
                oraUscita: document.getElementById('pres-uscita').value
            });
            saveData();
            updateAllTables();
            closeModal('addPresenzaModal');
            e.target.reset();
        }

        function addManutenzione(e) {
            e.preventDefault();
            db.manutenzioni.push({
                id: 'MAN' + Date.now(),
                attrezzatura: document.getElementById('man-attr').value,
                tipo: document.getElementById('man-tipo').value,
                data: document.getElementById('man-data').value,
                stato: document.getElementById('man-stato').value
            });
            saveData();
            updateAllTables();
            closeModal('addManutenzioneModal');
            e.target.reset();
        }

        function addFornitore(e) {
            e.preventDefault();
            db.fornitori.push({
                id: 'FOR' + Date.now(),
                ragioneSociale: document.getElementById('forn-ragione').value,
                piva: document.getElementById('forn-piva').value,
                categoria: document.getElementById('forn-categoria').value,
                telefono: document.getElementById('forn-tel').value
            });
            saveData();
            updateAllTables();
            closeModal('addFornitoreModal');
            e.target.reset();
        }

        function updateAllTables() {
            document.getElementById('cantieriBody').innerHTML = db.cantieri.length ? db.cantieri.map(c => `
                <tr><td><strong>${c.nome}</strong></td><td>${c.indirizzo}</td><td>${c.cliente}</td><td>${c.stato}</td>
                <td><button class="btn-danger" onclick="deleteCantiere('${c.id}')">üóëÔ∏è</button></td></tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;padding:40px;">Nessun cantiere</td></tr>';

            document.getElementById('attrezzatureBody').innerHTML = db.attrezzature.length ? db.attrezzature.map(a => `
                <tr><td>${a.codice}</td><td>${a.nome}</td><td>${a.tipo}</td><td>${a.stato}</td>
                <td><button class="btn-danger" onclick="deleteAttrezzatura('${a.id}')">üóëÔ∏è</button></td></tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;padding:40px;">Nessuna attrezzatura</td></tr>';

            document.getElementById('dipendentiBody').innerHTML = db.dipendenti.length ? db.dipendenti.map(d => `
                <tr><td>${d.matricola}</td><td>${d.nome} ${d.cognome}</td><td>${d.ruolo}</td>
                <td><button class="btn-danger" onclick="deleteDipendente('${d.id}')">üóëÔ∏è</button></td></tr>
            `).join('') : '<tr><td colspan="4" style="text-align:center;padding:40px;">Nessun dipendente</td></tr>';

            document.getElementById('presenzeBody').innerHTML = db.presenze.length ? db.presenze.map(p => `
                <tr><td>${p.data}</td><td>${p.dipendente}</td><td>${p.cantiere}</td><td>${p.oraIngresso}</td><td>${p.oraUscita||'-'}</td>
                <td><button class="btn-danger" onclick="deletePresenza('${p.id}')">üóëÔ∏è</button></td></tr>
            `).join('') : '<tr><td colspan="6" style="text-align:center;padding:40px;">Nessuna presenza</td></tr>';

            document.getElementById('manutenzioniBody').innerHTML = db.manutenzioni.length ? db.manutenzioni.map(m => `
                <tr><td>${m.data}</td><td>${m.attrezzatura}</td><td>${m.tipo}</td><td>${m.stato}</td>
                <td><button class="btn-danger" onclick="deleteManutenzione('${m.id}')">üóëÔ∏è</button></td></tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;padding:40px;">Nessuna manutenzione</td></tr>';

            document.getElementById('fornitoriBody').innerHTML = db.fornitori.length ? db.fornitori.map(f => `
                <tr><td>${f.ragioneSociale}</td><td>${f.piva}</td><td>${f.categoria}</td><td>${f.telefono||'-'}</td>
                <td><button class="btn-danger" onclick="deleteFornitore('${f.id}')">üóëÔ∏è</button></td></tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;padding:40px;">Nessun fornitore</td></tr>';

            const dipSelect = document.getElementById('pres-dipendente');
            if (dipSelect) dipSelect.innerHTML = '<option value="">Seleziona...</option>' + db.dipendenti.map(d => `<option value="${d.nome} ${d.cognome}">${d.nome} ${d.cognome}</option>`).join('');
            
            const cantieriSelect = document.getElementById('pres-cantiere');
            if (cantieriSelect) cantieriSelect.innerHTML = '<option value="">Seleziona...</option>' + db.cantieri.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');

            const attrSelect = document.getElementById('man-attr');
            if (attrSelect) attrSelect.innerHTML = '<option value="">Seleziona...</option>' + db.attrezzature.map(a => `<option value="${a.nome}">${a.codice} - ${a.nome}</option>`).join('');
        }

        function deleteCantiere(id) { if (confirm('Eliminare?')) { db.cantieri = db.cantieri.filter(c => c.id !== id); saveData(); updateAllTables(); updateDashboard(); } }
        function deleteAttrezzatura(id) { if (confirm('Eliminare?')) { db.attrezzature = db.attrezzature.filter(a => a.id !== id); saveData(); updateAllTables(); } }
        function deleteDipendente(id) { if (confirm('Eliminare?')) { db.dipendenti = db.dipendenti.filter(d => d.id !== id); saveData(); updateAllTables(); } }
        function deletePresenza(id) { if (confirm('Eliminare?')) { db.presenze = db.presenze.filter(p => p.id !== id); saveData(); updateAllTables(); } }
        function deleteManutenzione(id) { if (confirm('Eliminare?')) { db.manutenzioni = db.manutenzioni.filter(m => m.id !== id); saveData(); updateAllTables(); } }
        function deleteFornitore(id) { if (confirm('Eliminare?')) { db.fornitori = db.fornitori.filter(f => f.id !== id); saveData(); updateAllTables(); } }

        function updateDashboard() {
            document.getElementById('stat-cantieri').textContent = db.cantieri.filter(c => c.stato === 'attivo').length;
            document.getElementById('stat-attrezzature').textContent = db.attrezzature.length;
            document.getElementById('stat-dipendenti').textContent = db.dipendenti.length;
            document.getElementById('stat-utenti').textContent = Object.keys(getUsers()).length;
        }

        function loadUsers() {
            const users = getUsers();
            let html = '';
            for (const [username, userData] of Object.entries(users)) {
                const badge = userData.role === 'admin' ? 'badge-admin' : 'badge-user';
                const badgeText = userData.role === 'admin' ? 'üëë Admin' : 'üë§ User';
                const canDelete = username !== 'admin' && username !== currentUser;
                html += `<div class="user-card"><div><strong>${username}</strong> <span class="badge ${badge}">${badgeText}</span></div>
                <div>${canDelete ? `<button class="btn-danger" onclick="deleteUser('${username}')">üóëÔ∏è Elimina</button>` : '<span style="color:#999;">Protetto</span>'}</div></div>`;
            }
            document.getElementById('usersList').innerHTML = html;
        }

        function addUser(e) {
            e.preventDefault();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            if (username.includes(' ')) { alert('‚ùå Username senza spazi!'); return; }

            const users = getUsers();
            if (users[username]) { alert('‚ùå Username gi√† esistente!'); return; }

            users[username] = { password: hashPassword(password), role: role };
            saveUsers(users);
            alert('‚úÖ Utente creato!');
            closeModal('addUserModal');
            e.target.reset();
            loadUsers();
            updateDashboard();
        }

        function deleteUser(username) {
            if (confirm(`Eliminare utente "${username}"?`)) {
                const users = getUsers();
                delete users[username];
                saveUsers(users);
                alert('‚úÖ Utente eliminato!');
                loadUsers();
                updateDashboard();
            }
        }

        function downloadBackup() {
            const dataStr = JSON.stringify(db, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('Ripristinare backup?')) {
                        db = data;
                        saveData();
                        updateAllTables();
                        alert('‚úÖ Backup ripristinato!');
                    }
                } catch (error) {
                    alert('‚ùå File non valido');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
